import{r as h,c as z,h as ge,z as f,A as r,B as s,R as t,L as U,J as a,al as i,K as O,O as b,S as W,u as C,P as v,Q as G,a5 as J,E as he,I}from"./vendor-CBsB69ib.js";import{j as ye,k as be,f as xe,l as g,n as Ce,o as we,p as Fe,d as Pe,q as $e}from"./element-CPMJgIwH.js";import{u as Ve}from"./dashboard-BL77ydzG.js";import{a as Me}from"./api-BTqAopYE.js";import{_ as Ue}from"./index-DuDiLGTc.js";import"./axios-ngrFHoWO.js";const ke={class:"upload-page"},Ie={class:"card"},Ne={class:"metadata-section"},Te={class:"folder-upload-container"},Se={key:0,class:"folder-info"},ze={class:"folder-name"},De={class:"folder-stats"},Ae={class:"upload-actions"},Le={class:"card"},Re={key:0,class:"upload-tasks"},Be={class:"task-header"},Ee={class:"task-info"},je={class:"task-name"},qe={class:"task-metadata"},He={class:"file-count"},Oe={key:0,class:"task-progress"},We={class:"progress-text"},Ge={key:1,class:"task-result success"},Je={key:2,class:"task-result error"},Ke={key:3,class:"task-details"},Qe={class:"result-header"},Xe={class:"filename"},Ye={key:0,class:"result-message"},Ze={key:1,class:"upload-tips"},el={key:0,class:"card"},ll={class:"preview-content"},tl=["innerHTML"],sl={__name:"Upload",setup(al){const K=Ve(),D=h(),N=h(),F=h([]),P=h([]),A=h(""),y=h("file"),$=h(""),T=h(0),k=h([]),c=h({provider:"",category:"",title:""});let Q=0;const X=z(()=>"/api/v1/admin/documents/upload"),Y=z(()=>({})),Z=z(()=>({provider:c.value.provider,category:c.value.category,title:c.value.title})),ee=z(()=>!(y.value==="file"?F.value.length>0:k.value.length>0)||!c.value.provider||!c.value.category),L=[".md",".markdown",".doc",".docx",".pdf",".txt",".xlsx",".xls",".pptx",".ppt"],q=l=>{const e=l.toLowerCase().substring(l.lastIndexOf("."));return L.includes(e)},R=l=>{const e=l.lastIndexOf(".");return e>0?l.substring(0,e):l},le=l=>q(l.name)?l.size/1024/1024<10?!0:(g.error("文件大小不能超过 10MB!"),!1):(g.error(`不支持的文件格式！支持的格式：${L.join(", ")}`),!1),te=()=>{var l;y.value==="file"?(k.value=[],$.value="",T.value=0):((l=D.value)==null||l.clearFiles(),F.value=[])},se=()=>{var l;(l=N.value)==null||l.click()},ae=async l=>{const e=l.target.files;if(!e||e.length===0)return;const n=Array.from(e).filter(u=>q(u.name));if(n.length===0){g.warning(`所选文件夹中没有找到支持的文档文件。支持的格式：${L.join(", ")}`);return}const p=(n[0].webkitRelativePath||n[0].name).split("/")[0]||"未知文件夹";k.value=n.map(u=>({file:u,relativePath:u.webkitRelativePath||u.name,name:u.name,title:R(u.name)})),$.value=p,T.value=n.length,g.success(`已选择文件夹: ${p}，找到 ${n.length} 个支持的文档文件`)},oe=(l,e,n)=>{const p={id:++Q,name:n,provider:e.provider,category:e.category,fileCount:l.length,status:"uploading",progress:0,progressText:"准备上传...",successCount:0,results:[],errorMessage:""};return P.value.unshift(p),ne(p,l,e),p},ne=async(l,e,n)=>{try{const d=e.length;let p=0;for(const _ of e){try{const w=_.relativePath||_.name;l.progressText=`正在上传: ${w} (${p+1}/${d})`;const x=new FormData;x.append("file",_.file),x.append("provider",n.provider),x.append("category",n.category);const B=_.title||R(_.file.name);if(x.append("title",B),_.relativePath){const V=_.relativePath.split("/");if(V.length>1){const S=V.slice(1).join("/");x.append("relative_path",S)}}const m=await Me.uploadDocument(x);if(m&&m.status===200){const V=m.data||{};l.results.push({filename:w,success:!0,message:`上传成功，文档大小: ${V.size} 字节`}),l.successCount++}else l.results.push({filename:w,success:!1,message:"上传失败"})}catch{l.results.push({filename:_.relativePath||_.name,success:!1,message:"网络错误或上传失败"})}p++,l.progress=Math.round(p/d*100)}l.status="completed",l.progressText=`上传完成: ${l.successCount}/${d} 文件成功`;const u=l.results.length-l.successCount;l.successCount>0&&(K.markForRefresh(),window.dispatchEvent(new CustomEvent("dashboard-data-changed")),g.success(`任务"${l.name}"完成: 成功上传 ${l.successCount}/${d} 个文件`)),u>0&&g.warning(`任务"${l.name}": ${u} 个文件上传失败`)}catch(d){l.status="error",l.errorMessage="上传过程中发生错误",g.error(`任务"${l.name}"失败: ${l.errorMessage}`),console.error("Upload task error:",d)}},re=async()=>{const l=y.value==="file"?F.value.map(d=>({file:d.raw||d,relativePath:null,name:d.name,title:R(d.name)})):k.value;if(l.length===0){g.warning("请先选择文件或文件夹");return}if(!c.value.provider){g.warning("请选择云服务商");return}if(!c.value.category){g.warning("请选择产品分类");return}const e=y.value==="file"?l.length===1?l[0].name:`${l.length} 个文件`:$.value||"文件夹上传",n={...c.value};oe(l,n,e),H(),g.success(`已添加上传任务: ${e}`)},ue=(l,e)=>{console.log("Upload success:",l)},de=(l,e)=>{console.error("Upload error:",l)},ie=(l,e)=>{},ce=(l,e)=>{F.value=e},pe=l=>{const e=P.value.findIndex(n=>n.id===l);e!==-1&&P.value.splice(e,1)},H=()=>{var l;y.value==="file"?((l=D.value)==null||l.clearFiles(),F.value=[]):(k.value=[],$.value="",T.value=0,N.value&&(N.value.value="")),A.value="",c.value={provider:"",category:"",title:""}};return ge(()=>{}),(l,e)=>{const n=i("el-option"),d=i("el-select"),p=i("el-form-item"),u=i("el-col"),_=i("el-row"),w=i("el-radio"),x=i("el-radio-group"),B=i("el-input"),m=i("el-icon"),V=i("el-upload"),S=i("el-alert"),E=i("el-button"),j=i("el-tag"),fe=i("el-progress"),ve=i("el-collapse-item"),_e=i("el-collapse");return r(),f("div",ke,[e[16]||(e[16]=s("div",{class:"page-header"},[s("h2",null,"文档上传"),s("p",null,"支持上传Markdown格式的文档到知识库")],-1)),t(_,{gutter:20},{default:a(()=>[t(u,{span:16},{default:a(()=>[s("div",Ie,[e[13]||(e[13]=s("h3",null,"文件上传",-1)),s("div",Ne,[e[6]||(e[6]=s("h4",null,"文档信息",-1)),t(_,{gutter:20},{default:a(()=>[t(u,{span:12},{default:a(()=>[t(p,{label:"云服务商",required:""},{default:a(()=>[t(d,{modelValue:c.value.provider,"onUpdate:modelValue":e[0]||(e[0]=o=>c.value.provider=o),placeholder:"请选择云服务商",style:{width:"100%"}},{default:a(()=>[t(n,{label:"腾讯云",value:"腾讯云"}),t(n,{label:"阿里云",value:"阿里云"}),t(n,{label:"火山云",value:"火山云"}),t(n,{label:"华为云",value:"华为云"}),t(n,{label:"AWS",value:"AWS"}),t(n,{label:"Azure",value:"Azure"}),t(n,{label:"GCP",value:"GCP"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),t(u,{span:12},{default:a(()=>[t(p,{label:"产品分类",required:""},{default:a(()=>[t(d,{modelValue:c.value.category,"onUpdate:modelValue":e[1]||(e[1]=o=>c.value.category=o),placeholder:"请选择产品分类",style:{width:"100%"}},{default:a(()=>[t(n,{label:"负载均衡",value:"负载均衡"}),t(n,{label:"私有网络",value:"私有网络"}),t(n,{label:"弹性IP",value:"弹性IP"}),t(n,{label:"NAT网关",value:"NAT网关"}),t(n,{label:"专线",value:"专线"}),t(n,{label:"云联网",value:"云联网"}),t(n,{label:"VPN",value:"VPN"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(_,{gutter:20},{default:a(()=>[t(u,{span:12},{default:a(()=>[t(p,{label:"上传模式"},{default:a(()=>[t(x,{modelValue:y.value,"onUpdate:modelValue":e[2]||(e[2]=o=>y.value=o),onChange:te},{default:a(()=>[t(w,{label:"file"},{default:a(()=>[...e[4]||(e[4]=[b("单个/多个文件",-1)])]),_:1}),t(w,{label:"folder"},{default:a(()=>[...e[5]||(e[5]=[b("文件夹",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),t(u,{span:12},{default:a(()=>[t(p,{label:"文档标题"},{default:a(()=>[t(B,{modelValue:c.value.title,"onUpdate:modelValue":e[3]||(e[3]=o=>c.value.title=o),placeholder:"请输入文档标题（可选）"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),O(s("div",null,[t(V,{ref_key:"uploadRef",ref:D,class:"upload-dragger",drag:"",action:X.value,headers:Y.value,data:Z.value,"before-upload":le,"on-success":ue,"on-error":de,"on-progress":ie,"file-list":F.value,"auto-upload":!1,"on-change":ce,accept:".md,.markdown",multiple:""},{tip:a(()=>[...e[7]||(e[7]=[s("div",{class:"el-upload__tip"}," 支持 .md/.doc/.docx/.pdf/.txt/.xlsx/.xls/.pptx/.ppt 格式，且不超过 10MB ",-1)])]),default:a(()=>[t(m,{class:"el-icon--upload"},{default:a(()=>[t(C(ye))]),_:1}),e[8]||(e[8]=s("div",{class:"el-upload__text"},[b(" 将文件拖到此处，或"),s("em",null,"点击上传")],-1))]),_:1},8,["action","headers","data","file-list"])],512),[[W,y.value==="file"]]),O(s("div",Te,[s("div",{class:"upload-dragger",onClick:se},[t(m,{class:"el-icon--upload"},{default:a(()=>[t(C(be))]),_:1}),e[9]||(e[9]=s("div",{class:"el-upload__text"},[s("em",null,"点击选择文件夹")],-1)),e[10]||(e[10]=s("div",{class:"el-upload__tip"},[b(" 自动上传文件夹中所有文档"),s("br")],-1))]),s("input",{ref_key:"folderInputRef",ref:N,type:"file",webkitdirectory:"",directory:"",multiple:"",accept:".md,.markdown",style:{display:"none"},onChange:ae},null,544),$.value?(r(),f("div",Se,[t(S,{type:"success",closable:!1},{title:a(()=>[s("div",ze,[t(m,null,{default:a(()=>[t(C(xe))]),_:1}),s("span",null,"已选择文件夹: "+v($.value),1)]),s("div",De," 找到 "+v(T.value)+" 个支持的文档文件 ",1)]),_:1})])):U("",!0)],512),[[W,y.value==="folder"]]),s("div",Ae,[t(E,{type:"primary",onClick:re,disabled:ee.value},{default:a(()=>[...e[11]||(e[11]=[b(" 添加到上传队列 ",-1)])]),_:1},8,["disabled"]),t(E,{onClick:H},{default:a(()=>[...e[12]||(e[12]=[b("清空当前选择",-1)])]),_:1})])])]),_:1}),t(u,{span:8},{default:a(()=>[s("div",Le,[s("h3",null,"上传任务 ("+v(P.value.length)+")",1),P.value.length>0?(r(),f("div",Re,[(r(!0),f(G,null,J(P.value,o=>(r(),f("div",{key:o.id,class:he(["task-item",{"task-completed":o.status==="completed","task-error":o.status==="error"}])},[s("div",Be,[s("div",Ee,[o.status==="uploading"?(r(),I(m,{key:0},{default:a(()=>[t(C(Ce))]),_:1})):o.status==="completed"?(r(),I(m,{key:1,style:{color:"#67c23a"}},{default:a(()=>[t(C(we))]),_:1})):o.status==="error"?(r(),I(m,{key:2,style:{color:"#f56c6c"}},{default:a(()=>[t(C(Fe))]),_:1})):(r(),I(m,{key:3},{default:a(()=>[t(C(Pe))]),_:1})),s("span",je,v(o.name),1)]),o.status==="completed"||o.status==="error"?(r(),I(E,{key:0,type:"text",size:"small",onClick:M=>pe(o.id)},{default:a(()=>[t(m,null,{default:a(()=>[t(C($e))]),_:1})]),_:1},8,["onClick"])):U("",!0)]),s("div",qe,[t(j,{size:"small",type:"primary"},{default:a(()=>[b(v(o.provider),1)]),_:2},1024),t(j,{size:"small",type:"info"},{default:a(()=>[b(v(o.category),1)]),_:2},1024),s("span",He,v(o.fileCount)+" 个文件",1)]),o.status==="uploading"?(r(),f("div",Oe,[t(fe,{percentage:o.progress,status:o.progress===100?"success":""},null,8,["percentage","status"]),s("p",We,v(o.progressText),1)])):o.status==="completed"?(r(),f("div",Ge,[s("p",null,"✓ 上传完成: "+v(o.successCount)+"/"+v(o.fileCount)+" 文件成功",1)])):o.status==="error"?(r(),f("div",Je,[s("p",null,"✗ 上传失败: "+v(o.errorMessage),1)])):U("",!0),o.results&&o.results.length>0?(r(),f("div",Ke,[t(_e,null,{default:a(()=>[t(ve,{title:"查看详情",name:o.id},{default:a(()=>[(r(!0),f(G,null,J(o.results,(M,me)=>(r(),f("div",{key:me,class:"result-item"},[s("div",Qe,[s("span",Xe,v(M.filename),1),t(j,{type:M.success?"success":"danger",size:"small"},{default:a(()=>[b(v(M.success?"成功":"失败"),1)]),_:2},1032,["type"])]),M.message?(r(),f("div",Ye,v(M.message),1)):U("",!0)]))),128))]),_:2},1032,["name"])]),_:2},1024)])):U("",!0)],2))),128))])):(r(),f("div",Ze,[t(S,{title:"上传提示",type:"info",closable:!1},{default:a(()=>[...e[14]||(e[14]=[s("ul",null,[s("li",null,"支持批量上传多种格式文档（.md/.doc/.docx/.pdf/.txt/.xlsx/.xls/.pptx/.ppt）"),s("li",null,"支持直接上传包含多级子文件夹的目录"),s("li",null,"支持多个文件夹同时上传，互不影响"),s("li",null,"文件会自动解析并建立索引"),s("li",null,"上传完成后可立即搜索")],-1)])]),_:1})]))])]),_:1})]),_:1}),A.value?(r(),f("div",el,[e[15]||(e[15]=s("h3",null,"文档预览",-1)),s("div",ll,[s("div",{innerHTML:A.value},null,8,tl)])])):U("",!0)])}}},cl=Ue(sl,[["__scopeId","data-v-0bcca672"]]);export{cl as default};
